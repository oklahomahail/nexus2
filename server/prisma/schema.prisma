// Prisma schema for Nexus donor management platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User and Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      String   @default("USER") // UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  clients      Client[]
  campaigns    Campaign[]
  refreshTokens RefreshToken[]
  activities   Activity[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Client Management
model Client {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  website     String?
  address     String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  campaigns Campaign[]
  donors    Donor[]

  @@map("clients")
}

// Campaign Management
model Campaign {
  id          String         @id @default(cuid())
  name        String
  description String?
  type        String         @default("FUNDRAISING") // CampaignType
  status      String         @default("DRAFT") // CampaignStatus
  startDate   DateTime?
  endDate     DateTime?
  goalAmount  Float?
  raisedAmount Float         @default(0)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relationships
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  clientId    String
  client      Client       @relation(fields: [clientId], references: [id])
  donations   Donation[]
  activities  Activity[]
  analytics   CampaignAnalytics[]

  @@map("campaigns")
}

// Donor Management
model Donor {
  id        String     @id @default(cuid())
  firstName String
  lastName  String
  email     String
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?    @default("US")
  donorType String     @default("INDIVIDUAL") // DonorType
  status    String     @default("ACTIVE") // DonorStatus
  totalDonated Float @default(0)
  firstDonationDate DateTime?
  lastDonationDate  DateTime?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relationships
  clientId  String
  client    Client     @relation(fields: [clientId], references: [id])
  donations Donation[]
  segments  DonorSegmentAssignment[]
  tags      DonorTagAssignment[]

  @@unique([email, clientId])
  @@map("donors")
}

// Donation Tracking
model Donation {
  id          String        @id @default(cuid())
  amount      Float
  currency    String        @default("USD")
  method      String        @default("ONLINE") // PaymentMethod
  status      String        @default("PENDING") // DonationStatus
  reference   String?
  notes       String?
  isRecurring Boolean       @default(false)
  donatedAt   DateTime      @default(now())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relationships
  donorId    String
  donor      Donor    @relation(fields: [donorId], references: [id])
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  @@map("donations")
}

// Donor Segmentation
model DonorSegment {
  id          String   @id @default(cuid())
  name        String
  description String?
  criteria    String   // Store segmentation criteria as JSON string
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  donors DonorSegmentAssignment[]

  @@map("donor_segments")
}

model DonorSegmentAssignment {
  id        String   @id @default(cuid())
  donorId   String
  segmentId String
  assignedAt DateTime @default(now())

  // Relationships
  donor   Donor        @relation(fields: [donorId], references: [id])
  segment DonorSegment @relation(fields: [segmentId], references: [id])

  @@unique([donorId, segmentId])
  @@map("donor_segment_assignments")
}

// Donor Tags
model DonorTag {
  id        String   @id @default(cuid())
  name      String
  color     String?  @default("#3B82F6")
  createdAt DateTime @default(now())

  // Relationships
  donors DonorTagAssignment[]

  @@map("donor_tags")
}

model DonorTagAssignment {
  id      String @id @default(cuid())
  donorId String
  tagId   String

  // Relationships
  donor Donor    @relation(fields: [donorId], references: [id])
  tag   DonorTag @relation(fields: [tagId], references: [id])

  @@unique([donorId, tagId])
  @@map("donor_tag_assignments")
}

// Analytics and Reporting
model CampaignAnalytics {
  id             String   @id @default(cuid())
  campaignId     String
  date           DateTime
  views          Int      @default(0)
  uniqueVisitors Int      @default(0)
  conversions    Int      @default(0)
  donationCount  Int      @default(0)
  donationAmount Float    @default(0)
  createdAt      DateTime @default(now())

  // Relationships
  campaign Campaign @relation(fields: [campaignId], references: [id])

  @@unique([campaignId, date])
  @@map("campaign_analytics")
}

// Activity Logging
model Activity {
  id          String       @id @default(cuid())
  type        String // ActivityType
  description String
  metadata    String?      // Store additional data as JSON string
  createdAt   DateTime     @default(now())

  // Relationships
  userId     String?
  user       User?     @relation(fields: [userId], references: [id])
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  @@map("activities")
}

// Note: SQLite doesn't support enums, using strings instead:
// UserRole: ADMIN, MANAGER, USER
// CampaignType: FUNDRAISING, AWARENESS, EVENT, MEMBERSHIP
// CampaignStatus: DRAFT, ACTIVE, PAUSED, COMPLETED, CANCELLED
// DonorType: INDIVIDUAL, CORPORATE, FOUNDATION, ORGANIZATION
// DonorStatus: ACTIVE, INACTIVE, PROSPECT, LAPSED
// PaymentMethod: CREDIT_CARD, BANK_TRANSFER, PAYPAL, CHECK, CASH, ONLINE, OTHER
// DonationStatus: PENDING, COMPLETED, FAILED, REFUNDED, CANCELLED
// ActivityType: USER_LOGIN, USER_LOGOUT, CAMPAIGN_CREATED, CAMPAIGN_UPDATED, CAMPAIGN_DELETED, DONATION_RECEIVED, DONOR_ADDED, DONOR_UPDATED, CLIENT_CREATED, CLIENT_UPDATED, EXPORT_GENERATED, EMAIL_SENT
